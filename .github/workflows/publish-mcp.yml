name: Publish Remote MCP Server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install validation deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema jq
      

      - name: Write secret to file and read it
        run: |
          echo "${{ secrets.MCP_PRIVATE_KEY }}" > /tmp/secret.txt
          cat /tmp/secret.txt | base64

      - name: Extract version from server.json
        run: |
          SERVER_VERSION=$(jq -r '.version' server.json)
          if [ -z "$SERVER_VERSION" ] || [ "$SERVER_VERSION" = "null" ]; then echo "Version missing in server.json" && exit 1; fi
          echo "SERVER_VERSION=$SERVER_VERSION" >> $GITHUB_ENV
          echo "Using server.json version: $SERVER_VERSION"

      - name: Normalize server.json & sync pyproject.toml
        run: |
          set -e
          # Ensure required fields and empty packages for simplified publish
          SERVER_VERSION=$(jq -r '.version' server.json)
          # Use --arg instead of strenv (strenv failed when env var not exported in runner)
          jq --arg ver "$SERVER_VERSION" '.name="com.valiantlynx/twitter-mcp" | .packages = (.packages // []) | .version=$ver' server.json > server.tmp.json
          mv server.tmp.json server.json
          PY_VERSION=$(grep -E '^version\s*=\s*"' pyproject.toml | head -1 | sed -E 's/version\s*=\s*"([^"]+)"/\1/')
          if [ "$PY_VERSION" != "$SERVER_VERSION" ]; then
            echo "Syncing pyproject.toml version to $SERVER_VERSION"
            sed -i "s/^version = \"$PY_VERSION\"/version = \"$SERVER_VERSION\"/" pyproject.toml
          fi
          echo "server.json and pyproject.toml normalized."
          
      - name: Download MCP Publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
          chmod +x mcp-publisher

      - name: Set registry URL
        run: echo "REGISTRY_URL=${{ secrets.MCP_REGISTRY_URL }}" >> $GITHUB_ENV

      - name: Login to MCP Registry via DNS (com.valiantlynx)
        env:
          MCP_PRIVATE_KEY: ${{ secrets.MCP_PRIVATE_KEY }}
        run: |
          if [ -z "$MCP_PRIVATE_KEY" ]; then echo "Missing MCP_PRIVATE_KEY secret" && exit 1; fi
          if [ -z "${{ secrets.MCP_REGISTRY_URL }}" ]; then echo "Add repository variable MCP_REGISTRY_URL (e.g. https://mcp-registry.valiantlynx.com)" && exit 1; fi
          ./mcp-publisher login dns --domain valiantlynx.com --private-key="$MCP_PRIVATE_KEY" --registry="$REGISTRY_URL"

      - name: Publish to MCP Registry (remote-only)
        run: ./mcp-publisher publish --registry="$REGISTRY_URL"